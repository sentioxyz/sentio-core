services:
  clickhouse:
    image: clickhouse/clickhouse-server:25.9
    ports:
      - "9000:9000/tcp"
      - "8123:8123/tcp"
      - "9011:9000/tcp"  # for test local clickhouse-shard-0
      - "9012:9000/tcp"  # for test local clickhouse-shard-1
      - "9013:9000/tcp"  # for test local clickhouse-shard-0 external
      - "9014:9000/tcp"  # for test local clickhouse-shard-1 external
    volumes:
      - /tmp/docker/data/clickhouse:/var/lib/clickhouse
      - /tmp/docker/data/clickhouse/_log:/var/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    environment:
      - CLICKHOUSE_PASSWORD=password
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_DB=my_database
    restart: on-failure

  clickhouse-proxy-a:
    image: us-west1-docker.pkg.dev/sentio-352722/sentio/clickhouse-proxy:v0.1.0
    ports:
      - "19011:19011/tcp"
    volumes:
      - ./data/proxya.json:/app/config.json
    command: ["clickhouse-proxy", "-c", "/app/config.json"]
    restart: on-failure

  clickhouse-proxy-b:
    image: us-west1-docker.pkg.dev/sentio-352722/sentio/clickhouse-proxy:v0.1.0
    ports:
      - "19012:19012/tcp"
    volumes:
      - ./data/proxyb.json:/app/config.json
    command: ["clickhouse-proxy", "-c", "/app/config.json"]
    restart: on-failure
